<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funeral Admin System</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Typography & Layout */
        h1, h2, h3 { margin-bottom: 15px; }
        .flex { display: flex; gap: 10px; align-items: center; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none !important; }

        /* Buttons */
        .btn { padding: 8px 15px; border: none; cursor: pointer; border-radius: 4px; font-size: 14px; color: white; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-secondary { background: #6c757d; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; font-weight: 600; }
        
        /* Badges */
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .status-ACTIVE { background: #d4edda; color: #155724; }
        .status-DECEASED { background: #f8d7da; color: #721c24; }

        /* Forms */
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; border-radius: 8px; width: 500px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="container">
    <!-- HEADER -->
    <div class="flex-between" style="border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
        <h1 style="margin:0;">‚ö∞Ô∏è Funeral Admin</h1>
        <div class="flex">
            <span id="user-display" style="font-weight: bold; color:#555;"></span>
            <button class="btn btn-warning btn-sm" onclick="toggleModal('modal-password')">Change Password</button>
            <a href="/logout" class="btn btn-danger btn-sm">Logout</a>
        </div>
    </div>

    <!-- VIEW 1: MEMBER LIST -->
    <div id="view-dashboard">
        <div class="flex-between">
            <h2>Member Directory</h2>
            <div id="admin-controls" class="hidden flex">
                <button class="btn btn-primary" onclick="openPlansModal()">Manage Plans</button>
                <button class="btn btn-success" onclick="openCreateModal()">+ New Member</button>
            </div>
        </div>
        
        <!-- SEARCH BAR -->
        <input type="text" id="search-input" onkeyup="filterMembers()" 
               placeholder="üîç Search by Name or ID Number..." 
               style="padding: 12px; font-size: 16px; margin-bottom: 15px; border: 2px solid #eee;">

        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>ID Number</th>
                    <th>Status</th>
                    <th>Society Plan</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="member-table-body"></tbody>
        </table>
    </div>

    <!-- VIEW 2: FUNERAL DETAILS -->
    <div id="view-funeral" class="hidden">
        <!-- BUTTONS ROW -->
        <div class="flex-between" style="margin-bottom: 20px;">
            <button class="btn btn-secondary btn-sm" onclick="showDashboard()">‚Üê Back to Directory</button>
            <button class="btn btn-primary" onclick="printInvoice()">üñ®Ô∏è Print Quote / Invoice</button>
        </div>
        <h2 id="deceased-name" style="margin-top:10px;">Arrangement Details</h2>
        
        <div class="flex" style="margin-bottom:20px; text-align:center;">
            <div style="flex:1; background:#e9ecef; padding:15px; border-radius:4px;">
                <small>Total Cover</small><br><b id="cover-amount" style="font-size:1.2em;"></b>
            </div>
            <div style="flex:1; background:#f8d7da; padding:15px; border-radius:4px;">
                <small>Expenses</small><br><b id="total-expenses" style="font-size:1.2em; color:#721c24;"></b>
            </div>
            <div style="flex:1; background:#d4edda; padding:15px; border-radius:4px;">
                <small>Remaining</small><br><b id="remaining-balance" style="font-size:1.2em;"></b>
            </div>
        </div>

        <h3>Expenses</h3>
        <table>
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Cost</th>
                    <th style="width: 50px;"></th> <!-- Empty header for X button -->
                </tr>
            </thead>
            <tbody id="expense-table-body"></tbody>
        </table>
        
        <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-top:20px;">
            <h4>Add Expense</h4>
            <div class="flex" style="align-items: flex-end;">
                <div style="flex:2;">
                    <label>Select Item</label>
                    <select id="catalogue-select" style="margin:0;"></select>
                </div>
                <button class="btn btn-primary" onclick="addCatalogueExpense()">Add</button>
            </div>
            <div style="text-align:center; margin:10px; font-size:12px; color:#999;">- OR -</div>
            <div class="flex" style="align-items: flex-end;">
                <div style="flex:2;"><input type="text" id="manual-desc" placeholder="Custom Description" style="margin:0;"></div>
                <div style="flex:1;"><input type="number" id="manual-cost" placeholder="0.00" style="margin:0;"></div>
                <button class="btn btn-secondary" onclick="addManualExpense()">Add</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODALS ================= -->

<!-- 1. CREATE MEMBER -->
<div id="modal-create" class="modal-overlay hidden">
    <div class="modal-box">
        <div class="flex-between"><h3>New Member</h3><span style="cursor:pointer;" onclick="toggleModal('modal-create')">‚úï</span></div>
        <form onsubmit="createMember(event)">
            <input type="text" id="new-fname" placeholder="First Name" required>
            <input type="text" id="new-lname" placeholder="Last Name" required>
            <input type="text" id="new-id" placeholder="ID Number (Username)" required>
            <input type="text" id="new-phone" placeholder="Phone Number" required>
            <label>Society Plan:</label>
            <select id="new-society" required><option>Loading...</option></select>
            <button type="submit" class="btn btn-success" style="width:100%;">Create Member</button>
        </form>
    </div>
</div>

<!-- 2. MANAGE PLANS (NEW) -->
<div id="modal-plans" class="modal-overlay hidden">
    <div class="modal-box" style="width: 600px;">
        <div class="flex-between"><h3>Manage Society Plans</h3><span style="cursor:pointer;" onclick="toggleModal('modal-plans')">‚úï</span></div>
        
        <!-- List Plans -->
        <div style="max-height: 200px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #eee;">
            <table style="margin-top:0;">
                <thead><tr><th>Plan Name</th><th>Cover (R)</th><th>Action</th></tr></thead>
                <tbody id="plans-table-body"></tbody>
            </table>
        </div>

        <!-- Add/Edit Form -->
        <div style="background: #f9f9f9; padding: 15px; border-radius: 4px;">
            <h4 id="plan-form-title" style="margin-top:0;">Add New Plan</h4>
            <input type="hidden" id="plan-id"> <!-- Hidden ID for editing -->
            <div class="flex">
                <input type="text" id="plan-name" placeholder="Plan Name (e.g., VIP)" style="margin:0;">
                <input type="number" id="plan-cover" placeholder="Amount (e.g., 20000)" style="margin:0;">
                <button class="btn btn-primary" onclick="savePlan()">Save</button>
            </div>
            <button class="btn btn-secondary btn-sm hidden" id="cancel-edit-btn" onclick="resetPlanForm()" style="margin-top:5px;">Cancel Edit</button>
        </div>
    </div>
</div>

<!-- 3. CHANGE PASSWORD -->
<div id="modal-password" class="modal-overlay hidden">
    <div class="modal-box" style="width:300px;">
        <div class="flex-between"><h3>Change Password</h3><span style="cursor:pointer;" onclick="toggleModal('modal-password')">‚úï</span></div>
        <input type="password" id="new-password" placeholder="New Password">
        <button class="btn btn-primary" style="width:100%;" onclick="changePassword()">Update</button>
    </div>
</div>

<!-- PAYMENT MODAL -->
<div id="modal-payment" class="modal-overlay hidden">
    <div class="modal-box" style="width: 600px;">
        <div class="flex-between">
            <h3>Payments: <span id="pay-member-name"></span></h3>
            <span style="cursor:pointer;" onclick="toggleModal('modal-payment')">‚úï</span>
        </div>
        
        <!-- Summary Cards -->
        <div class="flex" style="margin-bottom: 20px; text-align: center;">
            <div style="flex:1; background:#e2e6ea; padding:10px; border-radius:4px;">
                <small>Plan Cost</small><br><b id="pay-premium"></b> p/m
            </div>
            <div style="flex:1; background:#d4edda; padding:10px; border-radius:4px;">
                <small>Total Paid</small><br><b id="pay-total"></b>
            </div>
            <div style="flex:1; background:#fff3cd; padding:10px; border-radius:4px;">
                <small>Outstanding</small><br><b id="pay-due" style="color:#856404;"></b>
            </div>
        </div>

        <!-- Add Payment Form -->
        <div style="background:#f8f9fa; padding:15px; border-radius:4px; margin-bottom:15px; border:1px solid #ddd;">
            <h4 style="margin-top:0;">Record New Payment</h4>
            <div class="flex">
                <input type="number" id="new-pay-amount" placeholder="Amount (R)" style="margin:0;">
                <button class="btn btn-success" onclick="submitPayment()">Submit Cash</button>
            </div>
        </div>

        <!-- History Table -->
        <h4>Payment History</h4>
        <div style="max-height: 200px; overflow-y: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Recorded By</th>
                        <th style="width: 80px;">Action</th> <!-- ADDED THIS -->
                    </tr>
                </thead>
                <tbody id="pay-history-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let currentUser = "";
    let isAdmin = false;
    let currentFuneralId = null;
    let currentFuneralData = null;

    document.addEventListener("DOMContentLoaded", async () => {
        // 1. Auth Check
        const res = await fetch('/api/me');
        currentUser = await res.text();
        document.getElementById('user-display').innerText = "User: " + currentUser;
        
        // 2. Role Check
        isAdmin = isNaN(currentUser);
        if(isAdmin) document.getElementById('admin-controls').classList.remove('hidden');

        loadMembers();
        loadCatalogue();
    });

    function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

    // ================= MEMBERS =================
    async function loadMembers() {
        const res = await fetch('/api/members');
        const members = await res.json();
        const tbody = document.getElementById('member-table-body');
        tbody.innerHTML = '';

        members.forEach(m => {
            const planName = m.society ? m.society.name : 'No Plan';
            const isDeceased = m.status === 'DECEASED';
            
            let actions = "";

            actions += `<button class="btn btn-primary btn-sm" onclick="openPaymentModal(${m.id}, '${m.firstName}')">Payments</button> `;
            
            if(isAdmin) {
                actions += `<button class="btn btn-danger btn-sm" onclick="deleteMember(${m.id})">Del</button> `;
                if(!isDeceased) actions += `<button class="btn btn-secondary btn-sm" onclick="setStatus(${m.id}, 'DECEASED')">Mark Died</button>`;
                else actions += `<button class="btn btn-warning btn-sm" onclick="setStatus(${m.id}, 'ACTIVE')">Revert</button>`;
            }
            if(isDeceased) actions += ` <button class="btn btn-success btn-sm" onclick="startFuneral(${m.id})">Funeral Inv.</button>`;

            tbody.innerHTML += `<tr>
                <td>${m.firstName} ${m.lastName}</td>
                <td>${m.idNumber}</td>
                <td><span class="status-badge status-${m.status}">${m.status}</span></td>
                <td>${planName}</td>
                <td>${actions}</td>
            </tr>`;
        });
    }

    async function createMember(e) {
        e.preventDefault();
        const data = {
            firstName: document.getElementById('new-fname').value,
            lastName: document.getElementById('new-lname').value,
            idNumber: document.getElementById('new-id').value,
            phoneNumber: document.getElementById('new-phone').value,
            society: { id: document.getElementById('new-society').value }
        };
        const res = await fetch('/api/admin/members', {
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)
        });
        if(res.ok) { toggleModal('modal-create'); loadMembers(); e.target.reset(); }
    }

    async function deleteMember(id) {
        if(confirm("Delete member?")) {
            await fetch(`/api/admin/members/${id}`, { method: 'DELETE' });
            loadMembers();
        }
    }

    async function setStatus(id, st) {
        await fetch(`/api/admin/members/${id}/status?status=${st}`, { method: 'PUT' });
        loadMembers();
    }

    async function openCreateModal() {
        toggleModal('modal-create');
        // Fetch Societies for Dropdown
        const res = await fetch('/api/societies');
        if(res.ok) {
            const list = await res.json();
            const sel = document.getElementById('new-society');
            sel.innerHTML = '<option value="">-- Select Plan --</option>';
            list.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.name} (R${s.coverageAmount})</option>`);
        } else {
            document.getElementById('new-society').innerHTML = '<option>Error loading plans</option>';
        }
    }

    // ================= PLANS MANAGEMENT =================
    async function openPlansModal() {
        toggleModal('modal-plans');
        loadPlansTable();
    }

    async function loadPlansTable() {
        const res = await fetch('/api/societies');
        const plans = await res.json();
        const tbody = document.getElementById('plans-table-body');
        tbody.innerHTML = '';
        plans.forEach(p => {
            tbody.innerHTML += `<tr>
                <td>${p.name}</td>
                <td>R ${p.coverageAmount}</td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="editPlan(${p.id}, '${p.name}', ${p.coverageAmount})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deletePlan(${p.id})">Del</button>
                </td>
            </tr>`;
        });
    }

    async function savePlan() {
        const id = document.getElementById('plan-id').value;
        const name = document.getElementById('plan-name').value;
        const cover = document.getElementById('plan-cover').value;
        if(!name || !cover) return alert("Enter details");

        const data = { name: name, coverageAmount: cover };
        let url = '/api/admin/societies';
        let method = 'POST';

        if(id) { // Update mode
            url += `/${id}`;
            method = 'PUT';
        }

        const res = await fetch(url, {
            method: method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)
        });

        if(res.ok) {
            resetPlanForm();
            loadPlansTable();
        }
    }

    function editPlan(id, name, cover) {
        document.getElementById('plan-id').value = id;
        document.getElementById('plan-name').value = name;
        document.getElementById('plan-cover').value = cover;
        document.getElementById('plan-form-title').innerText = "Edit Plan";
        document.getElementById('cancel-edit-btn').classList.remove('hidden');
    }

    function resetPlanForm() {
        document.getElementById('plan-id').value = '';
        document.getElementById('plan-name').value = '';
        document.getElementById('plan-cover').value = '';
        document.getElementById('plan-form-title').innerText = "Add New Plan";
        document.getElementById('cancel-edit-btn').classList.add('hidden');
    }

    async function deletePlan(id) {
        if(confirm("Delete this plan?")) {
            await fetch(`/api/admin/societies/${id}`, { method: 'DELETE' });
            loadPlansTable();
        }
    }

    // ================= FUNERALS =================
    function showDashboard() {
        document.getElementById('view-dashboard').classList.remove('hidden');
        document.getElementById('view-funeral').classList.add('hidden');
        loadMembers();
    }

    async function startFuneral(mid) {
        const res = await fetch(`/api/funeral/start?memberId=${mid}`, {method:'POST'});
        loadFuneralDetails(await res.json());
    }

    async function loadFuneralDetails(data) {
        currentFuneralData = data;

        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-funeral').classList.remove('hidden');
        currentFuneralId = data.id;

        document.getElementById('deceased-name').innerText = `Arrangement: ${data.deceasedMember.firstName} ${data.deceasedMember.lastName}`;
        
        let total = data.totalAllocatedBudget;
        let spent = data.expenses.reduce((s,i) => s + i.amount, 0);
        let bal = total - spent;

        document.getElementById('cover-amount').innerText = "R " + total.toFixed(2);
        document.getElementById('total-expenses').innerText = "- R " + spent.toFixed(2);
        const el = document.getElementById('remaining-balance');
        el.innerText = "R " + bal.toFixed(2);
        el.style.color = bal >= 0 ? '#155724' : '#721c24';

        const tb = document.getElementById('expense-table-body');
        tb.innerHTML = '';
        
        // UPDATED SECTION: Adds the Remove Button
        data.expenses.forEach(x => {
            tb.innerHTML += `
                <tr>
                    <td>${x.description}</td>
                    <td>R ${x.amount.toFixed(2)}</td>
                    <td style="text-align:right;">
                        <button class="btn btn-danger btn-sm" onclick="removeExpense(${x.id})" title="Remove Item">‚úï</button>
                    </td>
                </tr>`;
        });
    }

    async function loadCatalogue() {
        const res = await fetch('/api/catalogue');
        const list = await res.json();
        const sel = document.getElementById('catalogue-select');
        sel.innerHTML = '<option value="">-- Select --</option>';
        list.forEach(i => sel.innerHTML += `<option value="${i.id}">${i.name} (R ${i.price})</option>`);
    }

    async function addCatalogueExpense() {
        const id = document.getElementById('catalogue-select').value;
        if(id) {
            const res = await fetch(`/api/funeral/${currentFuneralId}/expense?itemId=${id}`, {method:'POST'});
            loadFuneralDetails(await res.json());
        }
    }

    async function addManualExpense() {
        const d = document.getElementById('manual-desc').value;
        const c = document.getElementById('manual-cost').value;
        if(d && c) {
            const res = await fetch(`/api/funeral/${currentFuneralId}/expense?manualDesc=${d}&manualAmount=${c}`, {method:'POST'});
            loadFuneralDetails(await res.json());
            document.getElementById('manual-desc').value = '';
            document.getElementById('manual-cost').value = '';
        }
    }

    async function removeExpense(expenseId) {
        if(!confirm("Remove this item?")) return;
        
        const res = await fetch(`/api/funeral/${currentFuneralId}/expense/${expenseId}`, {
            method: 'DELETE'
        });
        
        if(res.ok) {
            const updatedFuneral = await res.json();
            loadFuneralDetails(updatedFuneral);
        } else {
            alert("Error removing item");
        }
    }

    async function changePassword() {
        const p = document.getElementById('new-password').value;
        if(p) {
            await fetch(`/api/change-password?newPassword=${p}`, {method:'POST'});
            alert("Password Changed");
            toggleModal('modal-password');
        }
    }

    let currentMemberId = null;

    async function openPaymentModal(id, name) {
        currentMemberId = id;
        document.getElementById('pay-member-name').innerText = name;
        toggleModal('modal-payment');
        loadPaymentDetails();
    }

    async function loadPaymentDetails() {
        const res = await fetch(`/api/members/${currentMemberId}/finance`);
        const data = await res.json();

        document.getElementById('pay-premium').innerText = "R " + (data.monthlyPremium || 0).toFixed(2);
        document.getElementById('pay-total').innerText = "R " + (data.totalPaid || 0).toFixed(2);
        
        const due = data.outstandingDues || 0;
        const dueEl = document.getElementById('pay-due');
        dueEl.innerText = "R " + due.toFixed(2);
        if(due > 0) dueEl.parentElement.style.background = "#f8d7da";
        else dueEl.parentElement.style.background = "#d4edda";

        // --- UPDATED TABLE GENERATION ---
        const tbody = document.getElementById('pay-history-body');
        tbody.innerHTML = '';
        
        // Get member name for the receipt
        const memberName = document.getElementById('pay-member-name').innerText;

        data.history.forEach(p => {
            // We pass the payment details to the print function
            tbody.innerHTML += `<tr>
                <td>${p.paymentDate}</td>
                <td>R ${p.amount.toFixed(2)}</td>
                <td>${p.recordedBy || 'System'}</td>
                <td style="text-align: right;">
                    <button class="btn btn-secondary btn-sm" 
                        onclick="printReceipt('${p.id}', '${p.paymentDate}', '${p.amount.toFixed(2)}', '${p.recordedBy || 'System'}', '${memberName}')">
                        üñ®Ô∏è Print
                    </button>
                </td>
            </tr>`;
        });
    }

    async function submitPayment() {
        const amt = document.getElementById('new-pay-amount').value;
        if(!amt) return alert("Enter amount");

        const res = await fetch(`/api/members/${currentMemberId}/payment?amount=${amt}`, { method: 'POST' });
        if(res.ok) {
            document.getElementById('new-pay-amount').value = '';
            loadPaymentDetails(); // Refresh the numbers immediately
        }
    }

    function filterMembers() {
        const input = document.getElementById('search-input').value.toLowerCase();
        const rows = document.querySelectorAll('#member-table-body tr');
        
        rows.forEach(row => {
            // Get text from Name (col 0) and ID (col 1)
            const name = row.cells[0].innerText.toLowerCase();
            const id = row.cells[1].innerText.toLowerCase();
            
            // Check if input matches either
            if (name.includes(input) || id.includes(input)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    function printReceipt(id, date, amount, user, memberName) {
        // Create a new window
        const win = window.open('', '', 'height=600,width=400');
        
        // Design the Receipt HTML
        const html = `
            <html>
            <head>
                <title>Receipt #${id}</title>
                <style>
                    body { font-family: 'Courier New', monospace; padding: 20px; text-align: center; }
                    .header { margin-bottom: 20px; border-bottom: 2px dashed #000; padding-bottom: 10px; }
                    .logo { font-size: 20px; font-weight: bold; text-transform: uppercase; }
                    .sub-header { font-size: 12px; margin-top: 5px; }
                    .details { text-align: left; margin: 20px 0; font-size: 14px; line-height: 1.6; }
                    .amount-box { border: 2px solid #000; padding: 10px; font-size: 18px; font-weight: bold; margin: 20px 0; }
                    .footer { margin-top: 40px; font-size: 12px; border-top: 1px solid #000; padding-top: 10px; }
                    .signature { margin-top: 30px; text-align: left; }
                    .line { border-bottom: 1px solid #000; display: inline-block; width: 200px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="logo">Boikanyo's Funeral Home</div>
                    <div class="sub-header">"Your Problem Solver"</div>
                    <div class="sub-header">Tel: 012-345-6789 | Reg: 2023/123456/07</div>
                </div>

                <h3>OFFICIAL RECEIPT</h3>
                
                <div class="details">
                    <strong>Receipt No:</strong> #${id}<br>
                    <strong>Date:</strong> ${date}<br>
                    <strong>Received From:</strong> ${memberName}<br>
                    <strong>Payment For:</strong> Monthly Contribution<br>
                    <strong>Received By:</strong> ${user}
                </div>

                <div class="amount-box">
                    AMOUNT: R ${amount}
                </div>

                <div class="signature">
                    Signed: <span class="line"></span>
                </div>

                <div class="footer">
                    Thank you for your payment.<br>
                    Please keep this receipt as proof of payment.
                </div>
                
                <script>
                    window.print();
                    // Optional: Close window after print (uncomment to enable)
                    // window.onafterprint = function() { window.close(); }
                <\/script>
            </body>
            </html>
        `;

        win.document.write(html);
        win.document.close();
    }

    function printInvoice() {
        if(!currentFuneralData) return;
        const f = currentFuneralData;
        const member = f.deceasedMember;
        
        // Calculate Totals again for the print view
        const totalCover = f.totalAllocatedBudget;
        const totalExpenses = f.expenses.reduce((s, i) => s + i.amount, 0);
        const balance = totalCover - totalExpenses;

        // Generate Expense Rows
        let expenseRows = "";
        f.expenses.forEach(ex => {
            expenseRows += `
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${ex.description}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">R ${ex.amount.toFixed(2)}</td>
                </tr>
            `;
        });

        const win = window.open('', '', 'height=800,width=900');
        
        const html = `
            <html>
            <head>
                <title>Funeral Invoice - ${member.firstName} ${member.lastName}</title>
                <style>
                    body { font-family: 'Helvetica', sans-serif; padding: 40px; color: #333; }
                    .header { display: flex; justify-content: space-between; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                    .company-info h1 { margin: 0; font-size: 24px; text-transform: uppercase; }
                    .invoice-title { text-align: right; }
                    .invoice-title h2 { margin: 0; color: #555; }
                    
                    .info-grid { display: flex; justify-content: space-between; margin-bottom: 40px; }
                    .box { width: 45%; }
                    .label { font-weight: bold; font-size: 12px; color: #777; text-transform: uppercase; }
                    .val { font-size: 16px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }

                    table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                    th { text-align: left; background: #f4f4f4; padding: 10px; border-bottom: 2px solid #ddd; }
                    
                    .totals { float: right; width: 40%; }
                    .total-row { display: flex; justify-content: space-between; padding: 10px 0; font-size: 16px; }
                    .final-total { font-weight: bold; font-size: 20px; border-top: 2px solid #333; margin-top: 10px; padding-top: 10px; }
                    
                    .signatures { margin-top: 100px; display: flex; justify-content: space-between; clear: both; }
                    .sign-box { width: 40%; border-top: 1px solid #333; padding-top: 10px; text-align: center; font-size: 12px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="company-info">
                        <h1>Boikanyo's Funeral Home</h1>
                        <div style="font-size: 12px; margin-top: 5px;">
                            123 Main Street, Pretoria<br>
                            Tel: 012-345-6789 | Email: info@boikanyo.co.za
                        </div>
                    </div>
                    <div class="invoice-title">
                        <h2>FUNERAL QUOTATION</h2>
                        <div style="font-size: 14px;">Date: ${new Date().toISOString().split('T')[0]}</div>
                        <div style="font-size: 14px;">Ref: FUN-${f.id}</div>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="box">
                        <div class="label">Deceased Details</div>
                        <div class="val">${member.firstName} ${member.lastName}</div>
                        <div class="label">ID Number</div>
                        <div class="val">${member.idNumber}</div>
                    </div>
                    <div class="box">
                        <div class="label">Society Plan</div>
                        <div class="val">${member.society ? member.society.name : 'N/A'}</div>
                        <div class="label">Date of Death</div>
                        <div class="val">${f.dateOfDeath || 'N/A'}</div>
                    </div>
                </div>

                <h3>Selected Services & Expenses</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th style="text-align: right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${expenseRows}
                    </tbody>
                </table>

                <div class="totals">
                    <div class="total-row">
                        <span>Total Society Cover:</span>
                        <span>R ${totalCover.toFixed(2)}</span>
                    </div>
                    <div class="total-row" style="color: #dc3545;">
                        <span>Less Expenses:</span>
                        <span>- R ${totalExpenses.toFixed(2)}</span>
                    </div>
                    <div class="total-row final-total">
                        <span>Remaining Balance:</span>
                        <span>R ${balance.toFixed(2)}</span>
                    </div>
                    <div style="font-size: 11px; color: #777; margin-top: 10px; text-align: right;">
                        * Positive balance is paid to family.<br>
                        * Negative balance is owed to Parlour.
                    </div>
                </div>

                <div class="signatures">
                    <div class="sign-box">
                        <strong>Family Representative</strong><br>
                        I accept the above expenses and conditions.
                    </div>
                    <div class="sign-box">
                        <strong>Funeral Parlour Admin</strong><br>
                        Authorized Signature
                    </div>
                </div>

                <script>
                    window.print();
                <\/script>
            </body>
            </html>
        `;

        win.document.write(html);
        win.document.close();
    }
</script>

</body>
</html>